CREATE TABLE EMSD_ANIO_FABRICACION_VEHICULO(
    COD_ANIO_FABRICACION NUMBER,
    ANIO_FABRICACION DATE, -- ANIO_FABRICACION VARCHAR2(4) --
    CONSTRAINT PK_EMSD_ANIO_FABRICACION_VEHICULO PRIMARY KEY(COD_ANIO_FABRICACION)
);

--SECUENCIA TABLA
CREATE SEQUENCE SEQ_EMSD_ANIO_FABRICACION_VEHICULO
START WITH 1
INCREMENT BY 1
CACHE 200
NOCYCLE;

CREATE OR REPLACE PROCEDURE CRUD_ANIO_FABRICACION(
    OPCION VARCHAR2,
    COD_ANIO_P NUMBER,
    ANIO_FABRICACION_P DATE
)
IS
BEGIN
    LOCK TABLE EMSD_ANIO_FABRICACION_VEHICULO IN ROW EXCLUSIVE MODE;
    IF (UPPER(OPCION) = 'R') THEN
        INSERT INTO EMSD_ANIO_FABRICACION_VEHICULO(COD_ANIO_FABRICACION, ANIO_FABRICACION)
            VALUES(SEQ_EMSD_ANIO_FABRICACION_VEHICULO.NEXTVAL, ANIO_FABRICACION_P);
    END IF;
    IF (UPPER(OPCION)= 'U') THEN
        UPDATE EMSD_ANIO_FABRICACION_VEHICULO SET
            ANIO_FABRICACION = ANIO_FABRICACION_P
        WHERE(COD_ANIO_FABRICACION= COD_ANIO_P);
    END IF;
    IF (UPPER(OPCION)= 'D') THEN
        DELETE FROM EMSD_ANIO_FABRICACION_VEHICULO
        WHERE (COD_ANIO_FABRICACION = COD_ANIO_P);
    END IF;
    COMMIT;
    EXCEPTION
        WHEN STORAGE_ERROR THEN
            RAISE_APPLICATION_ERROR(-6500, 'Fallo de memoria')
        WHEN NO DATA FOUND THEN
            RAISE_APPLICATION_ERROR(-6500, 'La tabla no contiene datos')
        WHEN OTHERS THEN
            RAISE_APPLICATION_ERROR(-20010, 'Uh, fallé, saludos. :)');
    ROLLBACK;
END;

--TRIGGERS ()
CREATE OR REPLACE TRIGGER TRG_EMSD_ANIO_FABRICACION_VEHICULO
BEFORE INSERT 
ON EMSD_ANIO_FABRICACION_VEHICULO
FOR EACH ROW
BEGIN
    IF :NEW.ANIO_FABRICACION IS NULL THEN
        RAISE_APPLICATION_ERROR(-20001, 'El año de fabricación no puede estar vacío.');
    END IF;
    IF (LEN(:NEW.ANIO_FABRICACION)> 4) THEN
        RAISE_APPLICATION_ERROR(-20002, 'El formato del año no corresponde');
    END IF;
END;


--------

CREATE TABLE EMSD_ANIO_FABRICACION_VEHICULO(
    COD_ANIO_FABRICACION NUMBER,
    ANIO_FABRICACION NUMBER,
    CONSTRAINT PK_EMSD_ANIO_FABRICACION_VEHICULO PRIMARY KEY(COD_ANIO_FABRICACION)
);

--SECUENCIA TABLA
CREATE SEQUENCE SEQ_EMSD_ANIO_FABRICACION_VEHICULO
START WITH 1
INCREMENT BY 1
CACHE 200
NOCYCLE;


CREATE OR REPLACE TRIGGER EMSD_ANIO_FABRICACION_VEHICULO
BEFORE INSERT 
ON EMSD_ANIO_FABRICACION_VEHICULO
FOR EACH ROW
BEGIN
    :NEW.COD_ANIO_FABRICACION := SEQ_EMSD_ANIO_FABRICACION_VEHICULO.NEXTVAL;
    IF (:NEW.ANIO_FABRICACION IS NULL) THEN
        RAISE_APPLICATION_ERROR(-20001, 'El año de fabricación no puede estar vacío.');
    END IF;
    IF (:NEW.ANIO_FABRICACION < 1000) THEN
        RAISE_APPLICATION_ERROR(-20002, 'El formato del año no corresponde');
    END IF;
END;

