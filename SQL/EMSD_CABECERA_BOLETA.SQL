CREATE TABLE EMSD_CABECERA_BOLETA(
    COD_CABECERA NUMBER,
    COD_CLIENTE NUMBER,
    FECHA_EMISION DATE,
    COD_TRABAJADOR NUMBER,
    CONSTRAINT PK_EMSD_CABECERA_BOLETA PRIMARY KEY(COD_CABECERA),
    CONSTRAINT FK_EMSD_CABECERA_BOLETA_TRABAJADORES FOREIGN KEY(COD_TRABAJADOR) REFERENCES EMSD_TRABAJADORES(COD_TRABAJADOR)
);

CREATE SEQUENCE SEQ_PK_CABECERA
START WITH 1
INCREMENT BY 1
CACHE 200
NOCYCLE;

CREATE OR REPLACE FUNCTION F_NUEVA_VENTA(
) RETURN NUMBER
IS
    NUEVO_CLIENTE NUMBER;
BEGIN
    SELECT COD_CLIENTE INTO NUEVO_CLIENTE
    FROM (SELECT COD_CLIENTE
    	  FROM EMSD_VENTA
    	  ORDER BY COD_VENTA DESC)
    WHERE ROWNUM = 1;
    EXCEPTION
    	WHEN NO_DATA_FOUND THEN
    		RAISE_APPLICATION_ERROR (-20006, 'NO SE HAN REALIZADO VENTAS AÚN');
    END;
    RETURN NUEVO_CLIENTE;
END;


CREATE OR  REPLACE PROCEDURE PA_RD_CABECERA(
	OPCION VARCHAR2,
	COD_CLIENTE_P NUMBER
)
IS 
BEGIN
	LOCK TABLE EMSD_CABECERA_BOLETA IN ROW EXCLUSIVE MODE;
	IF (UPPER(OPCION)='R') THEN
		INSERT INTO EMSD_CABECERA_BOLETA(COD_CABECERA,COD_CLIENTE,FECHA_EMISION)
			VALUES(SEQ_PK_CABECERA.NEXTVAL,F_NUEVA_VENTA(), SYSDATE);
	END IF;
	IF (UPPER(OPCION)='D') THEN
		DELETE FROM EMSD_CABECERA_BOLETA
		WHERE COD_CLIENTE = COD_CLIENTE_P;
	END IF;
	COMMIT;
	EXCEPTION
    	WHEN NO_DATA_FOUND THEN
    		RAISE_APPLICATION_ERROR (-20006, 'NO SE HAN REALIZADO VENTAS AÚN');
    ROLLBACK;
END;
